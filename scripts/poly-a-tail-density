#!/usr/bin/env Rscript

sys = modules::import('klmr/sys')

sys$run({
    args = sys$cmd$parse(arg('taginfo', 'input taginfo file'))

    io = modules::import('ebi-predocs/ebits/io')
    modules::import_package('dplyr', attach = TRUE)

    taginfo = io$read_table(args$taginfo, header = TRUE)

    modules::import_package('ggplot2', attach = TRUE)

    pa_density_plot = ggplot() +
        aes(x = palen, y = ..density..) +
        geom_freqpoly(binwidth = 6) +
        scale_x_continuous(limits = c(0, 85), expand = c(0, 0)) +
        labs(x = 'poly-A length', y = 'Density of reads')

    #+ pA-density
    pa_density_plot %+%
        taginfo +
        aes(color = paste(type, treatment)) +
        labs(color = 'Condition')

    #+ viral-pa-density
    viral_taginfo = taginfo %>%
        filter(treatment == 'Uninfected') %>%
        mutate(`RNA source` = ifelse(grepl('ORV', gene, fixed = TRUE), gene, 'host'))

    pa_density_plot %+%
        viral_taginfo +
        aes(color = `RNA source`)
})

# vim: ft=r
